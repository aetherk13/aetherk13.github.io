<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" sizes="76x76" href="./assets/media/icon.png">
  <link rel="icon" type="image/png" href="./assets/media/icon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Kedar Krishnan | Skill Constellation</title>
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no" name="viewport" />
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
  <link href="./assets/css/bootstrap.min.css" rel="stylesheet" />
  <link href="./assets/css/paper-kit.css?v=2.2.0" rel="stylesheet" />
  <link href="./assets/demo/demo.css" rel="stylesheet" />
  <style>
    html, body { height: 100%; }
    body {
      overflow: hidden;
      background-color: rgba(212, 218, 220, 1);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .navbar.navbar-transparent {
      background-color: rgba(255, 255, 255, 0.96) !important;
      box-shadow: 0 4px 18px rgba(17, 17, 17, 0.12);
    }
    .navbar.navbar-transparent .navbar-brand,
    .navbar.navbar-transparent .navbar-nav > li > a,
    .navbar.navbar-transparent .btn { color: #101418 !important; }
    .navbar.navbar-transparent .btn.btn-danger {
      background-color: var(--color-primary); border-color: var(--color-primary); color: #ffffff !important;
    }
    .navbar.navbar-transparent .btn.btn-danger:hover,
    .navbar.navbar-transparent .btn.btn-danger:focus {
      background-color: var(--color-primary-dark); border-color: var(--color-primary-dark); color: #ffffff !important;
    }
    .navbar.navbar-transparent .navbar-toggler-bar { background: #101418; }

    footer.footer {
      position: fixed; bottom: 0; left: 0; width: 100%; z-index: 600;
      background-color: rgba(255, 255, 255, 0.96);
      margin: 0; border-top: 1px solid rgba(0, 0, 0, 0.08);
    }
    .footer-social { display: flex; gap: 28px; flex-wrap: wrap; }
    .footer-social a { display: flex; align-items: center; }
    .footer.footer-white .footer-social a { color: var(--color-primary); }
    .footer.footer-white .footer-social a:hover { color: var(--color-primary-dark); }
    .footer-social svg { width: 28px; height: 28px; }

    .constellation-wrapper {
      position: relative;
      width: 100%;
      height: 100vh;
      padding-top: 92px;
      padding-bottom: 96px;
      box-sizing: border-box;
      background-color: rgba(212, 218, 220, 1);
    }
    #skill-galaxy-viz { position: absolute; top: 92px; left: 0; right: 0; bottom: 96px; }
    .skill-galaxy__svg { width: 100%; height: 100%; display: block; }

    .core-node    text { font-size: 14px; font-weight: 700; text-anchor: middle; dominant-baseline: middle; alignment-baseline: middle; }
    .category-node text { font-size: 13px; font-weight: 700; text-anchor: middle; dominant-baseline: middle; alignment-baseline: middle; }
    .subfocus-node text { font-size: 12px; font-weight: 700; text-anchor: middle; dominant-baseline: middle; alignment-baseline: middle; }
    .skill-node   text { font-size: 8px; font-weight: 700; text-anchor: middle; dominant-baseline: middle; alignment-baseline: middle; }


    /* debug */
    .dbg-core  { stroke: #f97316; stroke-dasharray: 6 6; fill: none; opacity: 0.9; }
    .dbg-pad   { stroke: #475569; stroke-dasharray: 4 6; fill: none; opacity: 0.35; }
    .dbg-wall  { stroke: #2563eb; stroke-dasharray: 6 6; fill: rgba(37,99,235,0.05); }
    .dbg-ps    { stroke: currentColor; stroke-dasharray: 3 6; fill: none; opacity: 0.28; }

    /* control panel */
    .panel-wrap { position: absolute; top: 12px; right: 24px; z-index: 10; font-size: 12px; color: #0f172a; }
    .panel-trigger {
      background: #0f172a; color: #e2e8f0; border: 1px solid #1f2937; border-radius: 10px;
      padding: 8px 10px; cursor: pointer; opacity: 0.95;
    }
    .panel-trigger:hover { opacity: 1; }
    .panel {
      margin-top: 8px; width: 280px; max-height: 70vh; overflow: auto;
      background: #ffffffcc; backdrop-filter: blur(6px);
      border: 1px solid #cbd5e1; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      padding: 10px 12px; display: none;
    }
    .panel.open { display: block; }
    .panel h4 { margin: 8px 0 6px; font-size: 12px; color: #0f172a; }
    .panel .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; margin: 6px 0; }
    .panel .row label { font-size: 12px; }
    .panel .row input[type="range"] { width: 160px; }
    .panel .btns { display: flex; gap: 8px; margin-top: 8px; }
    .panel button.small {
      padding: 6px 8px; font-size: 12px; border-radius: 8px; border: 1px solid #1f2937; background: #0f172a; color: #e2e8f0;
      cursor: pointer;
    }
    .panel button.small.secondary { background: #f8fafc; color: #0f172a; border-color: #94a3b8; }

    /* Backdrop a tad softer */
    .modal-backdrop.show { opacity: .35; }

    /* Base shell */
    .modal-skill .modal-content {
      border-radius: 16px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(6px);
      box-shadow: 0 20px 40px rgba(17, 17, 17, 0.18);
      overflow: hidden; /* for top accent bar */
      transform: translateY(8px);
      transition: transform .25s ease;
    }
    .modal.show .modal-content { transform: translateY(0); }

    /* Thin accent bar using Paper Kit's primary/danger hues */
    .modal-skill .modal-accent {
      height: 4px;
      width: 100%;
      background: linear-gradient(90deg, #f96332, #f6ad55);
    }

    /* Header */
    .modal-skill .modal-header {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      background: linear-gradient(180deg, rgba(250, 250, 250, .85), rgba(255, 255, 255, .85));
    }
    .modal-skill .modal-title {
      margin: 0;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: .2px;
      padding-right: 32px;
      font-size: 1.28rem;
    }

    /* Close button */
    .modal-skill .close {
      outline: none !important;
      color: #0f172a;
      opacity: .55;
      text-shadow: none;
      transition: opacity .2s ease;
    }
    .modal-skill .close:hover { opacity: .9; }

    /* Body */
    .modal-skill .modal-body {
      padding: 18px 20px;
      color: #0c1220;
    }
    .modal-skill .modal-body p { margin-bottom: 10px; line-height: 1.55; }
    .modal-skill .modal-body .muted { color: #475569; font-size: 0.95em; }
    .modal-skill .modal-context {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #475569;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(100, 116, 139, 0.16);
      margin-bottom: 12px;
    }
    .modal-skill .modal-description {
      margin: 4px 0 14px 0;
      font-size: 0.96rem;
      color: #111827;
    }
    .modal-skill .modal-description--empty {
      color: #94a3b8;
      font-style: italic;
    }

    /* Project link list */
    .modal-skill .proj-list {
      margin: 10px 0 0;
      padding-left: 18px; /* bullets */
    }
    .modal-skill .proj-list li + li { margin-top: 6px; }
    .modal-skill .proj-link {
      text-decoration: none;
      color: #c2410c;
      border-bottom: 1px dashed rgba(194, 65, 12, .45);
      transition: color .15s ease, border-color .15s ease;
    }
    .modal-skill .proj-link:hover {
      color: #9a3412;
      border-color: rgba(154, 52, 18, .85);
    }

    /* Footer */
    .modal-skill .modal-footer {
      border-top: 1px solid rgba(15, 23, 42, 0.06);
      background: rgba(255, 255, 255, .9);
    }
    .modal-skill .btn-secondary.btn-round {
      background: #f8fafc;
      color: #0f172a;
      border: 1px solid #e2e8f0;
    }
    .modal-skill .btn-secondary.btn-round:hover {
      background: #eef2f7;
    }

    /* Optional: small badge styling inside the modal */
    .modal-skill .badge {
      font-weight: 600;
      padding: 5px 8px;
      border-radius: 999px;
    }

    /* Make links open in same tab (safety if any code adds target) */
    .modal-skill a[target="_blank"] { target-new: none; }


    @media (max-width: 768px) {
      .constellation-wrapper { padding-top: 86px; padding-bottom: 96px; }
      #skill-galaxy-viz { top: 86px; bottom: 96px; }
      .panel-wrap { top: 12px; right: 16px; }
    }
  </style>
</head>

<body class="index-page sidebar-collapse">
  <!-- Header -->
  <nav class="navbar navbar-expand-lg fixed-top navbar-transparent" color-on-scroll="300">
    <div class="container">
      <div class="navbar-translate">
        <a class="navbar-brand text-white" href="index.html" rel="tooltip" title="Coded by Kedar Krishnan" data-placement="bottom">
          Kedar Krishnan
        </a>
        <button class="navbar-toggler navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-bar bar1"></span>
          <span class="navbar-toggler-bar bar2"></span>
          <span class="navbar-toggler-bar bar3"></span>
        </button>
      </div>
      <div class="collapse navbar-collapse justify-content-end" id="navigation">
        <ul class="navbar-nav">
          <li class="nav-item"><a href="experience.html" class="btn btn-danger btn-round">Experiences</a></li>
          <li class="nav-item"><a href="projects.html" class="btn btn-danger btn-round">Projects</a></li>
          <li class="nav-item"><a href="constellation.html" class="btn btn-danger btn-round">Skills</a></li>
          <li class="nav-item"><a href="atlas.html" class="btn btn-danger btn-round">Photo Atlas</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Constellation -->
  <div class="constellation-wrapper">
    <div id="skill-galaxy-viz" role="region" aria-label="Skill Constellation">
      <!-- control panel -->
      <div class="panel-wrap">
        <button id="panel-toggle" class="panel-trigger" title="Controls">Controls</button>
        <div id="panel" class="panel" role="region" aria-label="Controls">
          <h4>Debug</h4>
          <div class="row">
            <label for="toggle-debug">Show radii</label>
            <input id="toggle-debug" type="checkbox" />
          </div>
          <div class="row">
            <label>Ellipse ratio</label>
            <span id="ellipse-ratio-label">1.00 : 1.00</span>
          </div>

          <h4>Params</h4>
          <div class="row"><label for="p-dt">dt</label><input id="p-dt" type="range" min="0.005" max="0.05" step="0.001"><span id="p-dt-val"></span></div>
          <div class="row"><label for="p-damp">damping</label><input id="p-damp" type="range" min="0.80" max="0.999" step="0.001"><span id="p-damp-val"></span></div>
          <div class="row"><label for="p-max">maxSpeed</label><input id="p-max" type="range" min="100" max="2000" step="10"><span id="p-max-val"></span></div>
          <div class="row"><label for="p-settle">settleIters</label><input id="p-settle" type="range" min="100" max="4000" step="50"><span id="p-settle-val"></span></div>

          <h4>Attraction</h4>
          <div class="row"><label for="ka-core-cat">core→category k</label><input id="ka-core-cat" type="range" min="0.0005" max="0.02" step="0.0005"><span id="ka-core-cat-val"></span></div>
          <div class="row"><label for="ka-cat-sub">category→sub k</label><input id="ka-cat-sub" type="range" min="0.05" max="1.0" step="0.01"><span id="ka-cat-sub-val"></span></div>
          <div class="row"><label for="ka-sub-skill">sub→skill k</label><input id="ka-sub-skill" type="range" min="0.05" max="1.0" step="0.01"><span id="ka-sub-skill-val"></span></div>

          <h4>Repulsion</h4>
          <div class="row"><label for="rcore-cat">core repel radius</label><input id="rcore-cat" type="range" min="100" max="1000" step="10"><span id="rcore-cat-val"></span></div>
          <div class="row"><label for="gap-cat-cat">category gap</label><input id="gap-cat-cat" type="range" min="100" max="600" step="10"><span id="gap-cat-cat-val"></span></div>
          <div class="row"><label for="gap-sub-sub">subfocus gap</label><input id="gap-sub-sub" type="range" min="50" max="400" step="5"><span id="gap-sub-sub-val"></span></div>
          <div class="row"><label for="gap-skill-skill">skill gap</label><input id="gap-skill-skill" type="range" min="40" max="200" step="2"><span id="gap-skill-skill-val"></span></div>

          <div class="btns"><button id="btn-reset-params" class="small" title="Reset all params to code defaults">Reset params</button></div>
        </div>
      </div>

      <svg class="skill-galaxy__svg" role="img" aria-label="Skill Constellation (Elliptical)"></svg>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer footer-black footer-white">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="footer-social">
            <a href="https://www.linkedin.com/in/kedar-krishnan/" target="_blank" aria-label="LinkedIn">
              <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg>
            </a>
            <a href="https://github.com/aetherk13" target="_blank" aria-label="GitHub">
              <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg>
            </a>
            <a href="https://www.instagram.com/kedark13/" target="_blank" aria-label="Instagram">
              <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,9.52A2.48,2.48,0,1,0,14.48,12,2.48,2.48,0,0,0,12,9.52Zm9.93-2.45a6.53,6.53,0,0,0-.42-2.26,4,4,0,0,0-2.32-2.32,6.53,6.53,0,0,0-2.26-.42C15.64,2,15.26,2,12,2s-3.64,0-4.93.07a6.53,6.53,0,0,0-2.26.42A4,4,0,0,0,2.49,4.81a6.53,6.53,0,0,0-.42,2.26C2,8.36,2,8.74,2,12s0,3.64.07,4.93a6.86,6.86,0,0,0,.42,2.27,3.94,3.94,0,0,0,.91,1.4,3.89,3.89,0,0,0,1.41.91,6.53,6.53,0,0,0,2.26.42C8.36,22,8.74,22,12,22s3.64,0,4.93-.07a6.53,6.53,0,0,0,2.26-.42,3.89,3.89,0,0,0,1.41-.91,3.94,3.94,0,0,0,.91-1.4,6.6,6.6,0,0,0,.42-2.27C22,15.64,22,15.26,22,12S22,8.36,21.93,7.07Zm-2.54,8A5.73,5.73,0,0,1,19,16.87,3.86,3.86,0,0,1,16.87,19a5.73,5.73,0,0,1-1.81.35c-.79,0-1,0-3.06,0s-2.27,0-3.06,0A5.73,5.73,0,0,1,7.13,19a3.51,3.51,0,0,1-1.31-.86A3.51,3.51,0,0,1,5,16.87a5.49,5.49,0,0,1-.34-1.81c0-.79,0-1,0-3.06s0-2.27,0-3.06A5.49,5.49,0,0,1,5,7.13a3.51,3.51,0,0,1,.86-1.31A3.59,3.59,0,0,1,7.13,5a5.73,5.73,0,0,1,1.81-.35h0c.79,0,1,0,3.06,0s2.27,0,3.06,0A5.73,5.73,0,0,1,16.87,5a3.51,3.51,0,0,1,1.31.86A3.51,3.51,0,0,1,19,7.13a5.73,5.73,0,0,1,.35,1.81c0,.79,0,1,0,3.06S19.42,14.27,19.39,15.06Zm-1.6-7.44a.9.9,0,0,1,0-1.79h0a.9.9,0,0,1,0,1.79Z"></path></svg>
            </a>
            <a href="https://scholar.google.com/citations?hl=en&amp;authuser=1&amp;user=g2t3ed4AAAAJ" target="_blank" aria-label="Google Scholar">
              <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 3 1.5 8.25 12 13.5 22.5 8.25 12 3zm0 12.27-6.75-3.78v3.3c0 2.82 2.86 5.21 6.75 5.21s6.75-2.39 6.75-5.21v-3.3L12 15.27zm8.25-4.32v5.5h1.5v-6.3l-1.5.8z"></path></svg>
            </a>
          </div>
        </div>
        <div class="col-md-6 text-md-right">
          <div class="credits ml-auto">
            <span class="copyright">© <script>document.write(new Date().getFullYear())</script> Kedar Krishnan · Design adapted from
              <a href="https://www.creative-tim.com/product/paper-kit-2" target="_blank">Paper Kit 2</a> by Creative Tim
            </span>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Vendor scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!-- D3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="./assets/data/skill-map.js"></script>

  <!-- Constellation logic (elliptical metric everywhere) -->
  <script>
  (async function () {
    const container = document.getElementById('skill-galaxy-viz');
    const svgEl = container?.querySelector('svg');
    const panelBtn = document.getElementById('panel-toggle');
    const panel = document.getElementById('panel');
    const toggleDebugInput = document.getElementById('toggle-debug');
    const btnResetParams = document.getElementById('btn-reset-params');
    const ellipseRatioLabel = document.getElementById('ellipse-ratio-label');
    if (!container || !svgEl) return;

    let hiddenCategoryIds = new Set();
    let skillsGenerated = {};
    try {
      const [taxonomy, generated] = await Promise.all([
        fetch("./assets/data/skill-taxonomy.json").then((res) => {
          if (!res.ok) throw new Error("taxonomy");
          return res.json();
        }),
        fetch("./assets/data/skills.generated.json")
          .then((res) => (res.ok ? res.json() : {}))
          .catch(() => ({}))
      ]);
      hiddenCategoryIds = new Set((taxonomy?.categories || []).filter((c) => c.hidden).map((c) => c.id));
      skillsGenerated = generated || {};
    } catch (err) {
      console.error("Failed to load skill data", err);
    }

    const skillGalaxy = window.skillGalaxy || { categories: [] };

    const slugify = (value = "") =>
      value
        .toLowerCase()
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9\s-]/g, "")
        .trim()
        .replace(/\s+/g, "-");

    const relatedIndex = skillsGenerated || {};
    const escapeHtml = (str = "") =>
      String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    // =========================
    // GLOBAL PARAMS
    // =========================
    const P = {
      pad: 5,
      coreR: 50, catR: 50, subR: 30, skillR: 15, labelSize: 12,
      mass: { core: Infinity, category: 50.0, subfocus: 1.2, skill: 0.7 },
      dt: 0.016, damping: 0.95, maxSpeed: 620,
      settleIters: 1400,
      repulsion: {
        core__category: { radius: 125, k: 100000, pow: 1 },
        core__subfocus: { radius: 800, k: 10000,  pow: 1 },
        core__skill:    { radius: 800, k: 3000,   pow: 1 },
        wall__category: { radius: 150, k: 30000 },
        wall__subfocus: { radius:  80, k: 22000 },
        wall__skill:    { radius:   0, k: 18000 },
        category__category: { gap: 350, k: 20000, pow: 1 },
        subfocus__subfocus: { gap: 200, k:  5000, pow: 1 },
        skill__skill:       { gap:  90, k:  4000, pow: 1 },
        category__subfocus: { gap: 100, k: 20000, pow: 1 },
        subfocus__skill:    { gap:  50, k:  1000, pow: 1 },
        category__skill:    { gap: 130, k: 12000, pow: 1 }
      },
      attraction: {
        core__category:     { k: 0.0045 },
        category__subfocus: { k: 0.5070 },
        subfocus__skill:    { k: 0.8500 }
      },
      angleEqualizerK_coreCats: 0,
      angleEqualizerK_catSubs:  0,
      angleEqualizerK_subSkills: 0
    };
    const P_DEFAULT = JSON.parse(JSON.stringify(P));

    // ellipse scales (screen -> scaled space)
    let width = 0, height = 0, cx = 0, cy = 0;
    let SX = 1, SY = 1;

    function updateEllipseScales() {
      if (height <= 0) { SX = 1; SY = 1; return; }
      const ar = width / height;
      SX = ar; SY = 1;
      if (ellipseRatioLabel) ellipseRatioLabel.textContent = `1.00 : ${ar.toFixed(2)}`;
    }

    // =========================
    // DATA
    // =========================
    const svg = d3.select(svgEl);

    const rawCats = (skillGalaxy.categories || [])
      .filter((cat) => !hiddenCategoryIds.has(cat?.id))
      .map((c, i) => ({
        id: c.id,
        label: c.label ?? c.id,
        display: c.display ?? null,
        color: c.color || '#64748b',
        groups: c.groups || [],
        _idx: i
      }));

    const cats = rawCats.map(d => ({
      id: d.id,
      label: d.display || d.label || d.id,
      fullLabel: d.label || d.id,
      color: d.color,
      type: 'category',
      x: 0, y: 0, vx: 0, vy: 0,
      r: P.catR,
      m: P.mass.category
    }));

    const subs = [];
    const skills = [];

    rawCats.forEach((c, ci) => {
      (c.groups || []).forEach((g, gi) => {
        const subId = `${c.id}__${g.id || ('g'+gi)}`;
        subs.push({
          id: subId,
          label: (g.display || g.label || subId),
          fullLabel: (g.label || subId),
          color: c.color,
          type: 'subfocus',
          parentId: c.id,
          x: 0, y: 0, vx: 0, vy: 0,
          r: P.subR,
          m: P.mass.subfocus
        });
        (g.skills || []).forEach((s, si) => {
          const skillId = `${subId}__${s.id || ('s'+si)}`;
          const label = s.display || s.label || skillId;
          const slug = slugify(s.label || label || skillId);
          skills.push({
            id: skillId,
            slug,
            label,
            fullLabel: s.label || skillId,
            color: c.color,
            type: 'skill',
            parentId: subId,
            description: typeof s.description === 'string' ? s.description.trim() : '',
            x: 0, y: 0, vx: 0, vy: 0,
            r: P.skillR,
            m: P.mass.skill,
            weight: s.weight || 1,
            related: [],
            projects: Array.isArray(s.projects) ? s.projects : []
          });
        });
      });
    });

    const hasRelatedIndex = Object.keys(relatedIndex).length > 0;
    skills.forEach((skill) => {
      const slug = skill.slug;
      const fromIndex = hasRelatedIndex ? (relatedIndex[slug]?.items || []) : [];
      if (fromIndex.length) {
        skill.related = fromIndex;
        return;
      }
      skill.related = (skill.projects || []).map((title) => ({
        title,
        url: '#',
        kind: 'project',
        slug: slugify(title)
      }));
    });

    const core = { id: 'core', type:'core', x: 0, y: 0, vx: 0, vy: 0, r: P.coreR, m: P.mass.core };

    const byId = new Map([[core.id, core]]);
    [...cats, ...subs, ...skills].forEach(n => byId.set(n.id, n));
    const skillBySlug = new Map();
    skills.forEach(s => { if (s.slug) skillBySlug.set(s.slug, s); });

    // =========================
    // RENDER LAYERS
    // =========================
    const gDebug = svg.append('g').attr('class', 'debug');
    const gLinks = svg.append('g').attr('class', 'links');
    const gNodes = svg.append('g').attr('class', 'nodes');

    const linkData = [
      ...cats.map(c => ({ source: core.id, target: c.id, color: c.color })),
      ...subs.map(s => ({ source: s.parentId, target: s.id, color: byId.get(s.parentId).color })),
      ...skills.map(k => ({ source: k.parentId, target: k.id, color: byId.get(k.parentId).color }))
    ];

    const linkSel = gLinks.selectAll('line')
      .data(linkData, d => d.source + '→' + d.target)
      .enter().append('line')
      .attr('stroke', d => d.color)
      .attr('stroke-opacity', 0.5)
      .attr('stroke-width', 1.8);

    const coreG = gNodes.append('g').attr('class', 'core-node');
    coreG.append('circle').attr('r', P.coreR).attr('fill', '#fbd38d').attr('stroke', '#f97316').attr('stroke-width', 3.2);
    coreG.append('text').attr('text-anchor', 'middle').attr('fill', '#0f172a').text('Skill Core');

    const catG = gNodes.selectAll('g.category-node')
      .data(cats, d => d.id).enter().append('g').attr('class', 'category-node').attr('color', d => d.color);
    catG.append('circle').attr('r', P.catR)
      .attr('fill', d => d3.color(d.color).copy({ opacity: 0.18 }))
      .attr('stroke', d => d.color).attr('stroke-width', 2.6);
    catG.append('text')
      .attr('class','node-label')
      .attr('text-anchor', 'middle')
      .attr('fill', '#0f172a')
      .text(d => d.label);

    const subG = gNodes.selectAll('g.subfocus-node')
      .data(subs, d => d.id).enter().append('g').attr('class', 'subfocus-node').attr('color', d => d.color);
    subG.append('circle').attr('r', P.subR)
      .attr('fill', d => d3.color(d.color).copy({ opacity: 0.14 }))
      .attr('stroke', d => d.color).attr('stroke-width', 2.2);
    subG.append('text')
      .attr('class','node-label')
      .attr('text-anchor', 'middle')
      .attr('fill', '#0f172a')
      .text(d => d.label);

    const skillG = gNodes.selectAll('g.skill-node')
      .data(skills, d => d.id).enter().append('g').attr('class', 'skill-node').attr('color', d => d.color);
    skillG.append('circle').attr('r', P.skillR)
      .attr('fill', d => d3.color(d.color).copy({ opacity: 0.20 }))
      .attr('stroke', d => d.color).attr('stroke-width', 2.0);
    skillG.append('text')
      .attr('class','node-label')
      .attr('text-anchor', 'middle')
      .attr('fill', '#0f172a')
      .text(d => d.label);

    // =========================
    // DEBUG (ellipses)
    // =========================
    let showDebug = false;
    const dbgPad  = gDebug.append('rect').attr('class', 'dbg-pad');
    const dbgCore = gDebug.append('ellipse').attr('class', 'dbg-core');
    const dbgWallCats = gDebug.append('rect').attr('class', 'dbg-wall');
    const dbgWallSubs = gDebug.append('rect').attr('class', 'dbg-wall').attr('opacity', 0.55);
    const dbgWallSkills = gDebug.append('rect').attr('class', 'dbg-wall').attr('opacity', 0.35);

    const dbgPS = gDebug.selectAll('ellipse.dbg-ps')
      .data([...cats, ...subs, ...skills], d => d.id)
      .enter().append('ellipse')
      .attr('class', 'dbg-ps')
      .attr('color', d => d.color);

      function renderDebug() {
        if (!showDebug) { gDebug.style('display', 'none'); return; }
        gDebug.style('display', null);

        const pad = P.pad;
        dbgPad.attr('x', pad).attr('y', pad)
            .attr('width', Math.max(0, width - pad * 2))
            .attr('height', Math.max(0, height - pad * 2));

        dbgCore
          .attr('cx', cx)
          .attr('cy', cy)
          .attr('rx', (P.repulsion.core__category.radius) * SX)
          .attr('ry', (P.repulsion.core__category.radius) * SY);

        const wrCat = Math.min(P.repulsion.wall__category.radius, Math.min(width, height)/2 - pad - 1);
        dbgWallCats
          .attr('x', pad + wrCat).attr('y', pad + wrCat)
          .attr('width', Math.max(0, width  - (pad + wrCat) * 2))
          .attr('height', Math.max(0, height - (pad + wrCat) * 2));
        const wrSub = Math.min(P.repulsion.wall__subfocus.radius, Math.min(width, height)/2 - pad - 1);
        dbgWallSubs
          .attr('x', pad + wrSub).attr('y', pad + wrSub)
          .attr('width', Math.max(0, width  - (pad + wrSub) * 2))
          .attr('height', Math.max(0, height - (pad + wrSub) * 2));
        const wrSkill = Math.min(P.repulsion.wall__skill.radius, Math.min(width, height)/2 - pad - 1);
        dbgWallSkills
          .attr('x', pad + wrSkill).attr('y', pad + wrSkill)
          .attr('width', Math.max(0, width  - (pad + wrSkill) * 2))
          .attr('height', Math.max(0, height  - (pad + wrSkill) * 2));

        dbgPS
          .attr('cx', d => d.x)
          .attr('cy', d => d.y)
          .attr('rx', d => (d.r + getGapForNode(d)) * SX)
          .attr('ry', d => (d.r + getGapForNode(d)) * SY)
          .attr('color', d => d.color);
      }

    function getGapForNode(n) {
      if (n.type === 'category') return P.repulsion.category__category.gap || 0;
      if (n.type === 'subfocus') return P.repulsion.subfocus__subfocus.gap || 0;
      if (n.type === 'skill')    return P.repulsion.skill__skill.gap || 0;
      return 0;
    }

    // =========================
    // HELPERS (elliptical)
    // =========================
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const TAU = Math.PI * 2;

    function toScaled(dx, dy) { return { dxs: dx / SX, dys: dy / SY }; }
    function scaledDistAndUnit(dx, dy) {
      const { dxs, dys } = toScaled(dx, dy);
      const d = Math.hypot(dxs, dys) || 1e-6;
      const ux = (dxs / d) / SX;
      const uy = (dys / d) / SY;
      return { dScaled: d, ux, uy, dxs, dys };
    }
    function polarToXYEllipse(cx, cy, r, a) { return { x: cx + r * SX * Math.cos(a), y: cy + r * SY * Math.sin(a) }; }
    function rScaledConservative(r) { return Math.max(r / SX, r / SY); }

    // =========================
    // SEEDERS (elliptical, slice)
    // =========================
    function seedRandom() {
      const N = Math.max(1, cats.length);
      const step = TAU / N;
      for (let i = 0; i < N; i++) {
        const a = i * step + (Math.random() - 0.5) * 0.2;
        const r0 = 70 + Math.random() * 30;
        const pos = polarToXYEllipse(cx, cy, r0, a);
        const c = cats[i];
        c.x = pos.x; c.y = pos.y; c.vx = 0; c.vy = 0;
      }
      subs.forEach((s) => {
        const p = byId.get(s.parentId);
        const ax = Math.atan2((p.y - cy) / SY, (p.x - cx) / SX);
        const a = ax + (Math.random() - 0.5) * 0.6;
        const r1 = 62 + Math.random() * 28;
        const pos = polarToXYEllipse(p.x, p.y, r1, a);
        s.x = pos.x; s.y = pos.y; s.vx = 0; s.vy = 0;
      });
      skills.forEach((k) => {
        const p = byId.get(k.parentId);
        const a = Math.random() * TAU;
        const r2 = 36 + Math.random() * 20;
        const pos = polarToXYEllipse(p.x, p.y, r2, a);
        k.x = pos.x; k.y = pos.y; k.vx = 0; k.vy = 0;
      });
    }

    function seedSlices() {
      const pad = P.pad;
      const inner = Math.max(80, Math.min(width, height) * 0.14);
      const subRing = inner + 60;
      const skillRing = 36;

      const N = Math.max(1, cats.length);
      const halfSlice = (Math.PI * 2) / (2 * N); // 360/N/2

      for (let i = 0; i < N; i++) {
        const a0 = (i / N) * (Math.PI * 2) + halfSlice;
        const catPos = polarToXYEllipse(cx, cy, inner, a0);
        const c = cats[i];
        c.x = clamp(catPos.x, pad + c.r, width - pad - c.r);
        c.y = clamp(catPos.y, pad + c.r, height - pad - c.r);
        c.vx = 0; c.vy = 0;
      }

      const subsByCat = d3.group(subs, s => s.parentId);
      cats.forEach((c) => {
        const arr = subsByCat.get(c.id) || [];
        if (!arr.length) return;
        const baseAng = Math.atan2((c.y - cy) / SY, (c.x - cx) / SX) + halfSlice;
        const span = Math.min(Math.PI / 3, (Math.PI * 2) / Math.max(2, arr.length));
        const aStart = baseAng - span / 2;
        for (let i = 0; i < arr.length; i++) {
          const a = aStart + (span * (i + 0.5)) / arr.length;
          const p = polarToXYEllipse(c.x, c.y, subRing, a);
          const s = arr[i];
          s.x = clamp(p.x, pad + s.r, width - pad - s.r);
          s.y = clamp(p.y, pad + s.r, height - pad - s.r);
          s.vx = 0; s.vy = 0;
        }
      });

      const skillsBySub = d3.group(skills, k => k.parentId);
      subs.forEach((s) => {
        const arr = skillsBySub.get(s.id) || [];
        if (!arr.length) return;
        const baseAng = Math.atan2((s.y - cy) / SY, (s.x - cx) / SX) + halfSlice;
        const span = Math.min(Math.PI / 6, Math.PI / Math.max(2, arr.length));
        const aStart = baseAng - span / 2;
        for (let i = 0; i < arr.length; i++) {
          const a = aStart + (span * (i + 0.5)) / arr.length;
          const p = polarToXYEllipse(s.x, s.y, skillRing, a);
          const k = arr[i];
          k.x = clamp(p.x, pad + k.r, width - pad - k.r);
          k.y = clamp(p.y, pad + k.r, height - pad - k.r);
          k.vx = 0; k.vy = 0;
        }
      });
    }

    // =============== MASS-AWARE FORCE ADDER ===============
    function addForce(n, fx, fy) {
      const invM = (n.m === Infinity) ? 0 : (1 / n.m);
      n.vx += fx * invM * P.dt;
      n.vy += fy * invM * P.dt;
    }

    // =========================
    // PHYSICS
    // =========================
    function attractCoreCategory(n) {
      const k = P.attraction.core__category.k;
      const { dxs, dys } = toScaled(core.x - n.x, core.y - n.y);
      addForce(n, (dxs * k) / SX, (dys * k) / SY);
    }
    function attractCategorySub(s) {
      const k = P.attraction.category__subfocus.k;
      const p = byId.get(s.parentId);
      const { dxs, dys } = toScaled(p.x - s.x, p.y - s.y);
      addForce(s, (dxs * k) / SX, (dys * k) / SY);
    }
    function attractSubSkill(kNode) {
      const k = P.attraction.subfocus__skill.k;
      const p = byId.get(kNode.parentId);
      const { dxs, dys } = toScaled(p.x - kNode.x, p.y - kNode.y);
      addForce(kNode, (dxs * k) / SX, (dys * k) / SY);
    }

    function repelCore(n, rule) {
      const { dScaled, ux, uy } = scaledDistAndUnit(n.x - cx, n.y - cy);
      if (dScaled < rule.radius) {
        const fmag = (rule.k) / Math.pow(dScaled, rule.pow || 2);
        addForce(n, ux * fmag, uy * fmag);
      }
    }

    function repelWalls(n, rule) {
      const pad = P.pad, R = rule.radius, k = rule.k;
      const dL = n.x - pad;               if (dL < R) addForce(n, +k * (1 - dL / R), 0);
      const dR = (width - pad) - n.x;     if (dR < R) addForce(n, -k * (1 - dR / R), 0);
      const dT = n.y - pad;               if (dT < R) addForce(n, 0, +k * (1 - dT / R));
      const dB = (height - pad) - n.y;    if (dB < R) addForce(n, 0, -k * (1 - dB / R));
    }

    function repelPairs(arrA, arrB, rule, symmetricPush=true) {
      const pow = rule.pow || 2, gap = rule.gap || 0, k = rule.k || 0;
      for (let i = 0; i < arrA.length; i++) {
        const a = arrA[i];
        const jStart = (arrA === arrB) ? i + 1 : 0;
        for (let j = jStart; j < arrB.length; j++) {
          const b = arrB[j]; if (a === b) continue;
          const dx = b.x - a.x, dy = b.y - a.y;
          const { dScaled, ux, uy } = scaledDistAndUnit(dx, dy);
          const need = rScaledConservative(a.r) + rScaledConservative(b.r) + (gap ? rScaledConservative(gap) : 0);
          if (dScaled >= need) continue;
          const fmag = k / Math.pow(dScaled || 1e-6, pow);
          const fx = ux * fmag, fy = uy * fmag;
          if (!a.dragging) addForce(a, -fx, -fy);
          if (symmetricPush && !b.dragging) addForce(b, +fx, +fy);
        }
      }
    }

    function equalizeAnglesAround(point, arr, K) {
      if (!K || arr.length < 2) return;
      const angs = arr.map((n, i) => ({ i, a: Math.atan2((n.y - point.y)/SY, (n.x - point.x)/SX) }))
                      .sort((p,q)=>p.a - q.a);
      const N = angs.length, step = (2*Math.PI)/N;
      const avg = angs.reduce((s,p)=>s+p.a,0)/N;
      for (let k = 0; k < N; k++) {
        const idx = angs[k].i;
        const node = arr[idx];
        if (node.dragging) continue;
        let dA = (avg + k*step) - angs[k].a;
        while (dA >  Math.PI) dA -= 2*Math.PI;
        while (dA < -Math.PI) dA += 2*Math.PI;
        const rx = node.x - point.x, ry = node.y - point.y;
        const { dScaled, ux, uy } = scaledDistAndUnit(rx, ry);
        const tangX = -uy, tangY = ux;
        const mag = K * dA * (dScaled || 1e-6);
        addForce(node, tangX * mag, tangY * mag);
      }
    }

    // =========================
    // INTEGRATION
    // =========================
    function integrate(n) {
      const v = Math.hypot(n.vx, n.vy);
      if (v > P.maxSpeed) { n.vx = (n.vx / v) * P.maxSpeed; n.vy = (n.vy / v) * P.maxSpeed; }
      n.x += n.vx * P.dt; n.y += n.vy * P.dt;
      n.vx *= P.damping; n.vy *= P.damping;
      const pad = P.pad, r = n.r;
      n.x = clamp(n.x, pad + r, width  - pad - r);
      n.y = clamp(n.y, pad + r, height - pad - r);
    }

    // =========================
    // TICK / SETTLE
    // =========================
    function tick() {
      cats.forEach(n => { if (!n.dragging) attractCoreCategory(n); });
      subs.forEach(n => { if (!n.dragging) attractCategorySub(n); });
      skills.forEach(n => { if (!n.dragging) attractSubSkill(n); });

      cats.forEach(n => { if (!n.dragging) { repelCore(n, P.repulsion.core__category); repelWalls(n, P.repulsion.wall__category); } });
      subs.forEach(n => { if (!n.dragging) { repelCore(n, P.repulsion.core__subfocus); repelWalls(n, P.repulsion.wall__subfocus); } });
      skills.forEach(n => { if (!n.dragging) { repelCore(n, P.repulsion.core__skill);  repelWalls(n, P.repulsion.wall__skill);  } });

      repelPairs(cats,   cats,   P.repulsion.category__category, true);
      repelPairs(subs,   subs,   P.repulsion.subfocus__subfocus, true);
      repelPairs(skills, skills, P.repulsion.skill__skill,       true);
      repelPairs(cats,   subs,   P.repulsion.category__subfocus, true);
      repelPairs(subs,   skills, P.repulsion.subfocus__skill,    true);
      repelPairs(cats,   skills, P.repulsion.category__skill,    true);

      if (P.angleEqualizerK_coreCats > 0) equalizeAnglesAround({x:cx,y:cy}, cats, P.angleEqualizerK_coreCats);
      if (P.angleEqualizerK_catSubs  > 0) {
        const subsByCat = d3.group(subs, s => s.parentId);
        subsByCat.forEach((arr, parentId) => equalizeAnglesAround(byId.get(parentId), arr, P.angleEqualizerK_catSubs));
      }
      if (P.angleEqualizerK_subSkills > 0) {
        const skillsBySub = d3.group(skills, k => k.parentId);
        skillsBySub.forEach((arr, parentId) => equalizeAnglesAround(byId.get(parentId), arr, P.angleEqualizerK_subSkills));
      }

      cats.forEach(n => { if (!n.dragging) integrate(n); });
      subs.forEach(n => { if (!n.dragging) integrate(n); });
      skills.forEach(n => { if (!n.dragging) integrate(n); });
    }
    function settle() { for (let i = 0; i < P.settleIters; i++) tick(); }

    // =========================
    // TEXT WRAPPING (SVG tspans)
    // =========================
    function wrapText(selection, maxWidth, lineHeightEm = 1.12, maxLines = 3) {
      selection.each(function(d) {
        const text = d3.select(this);
        const full = d.label || text.text();
        const words = full.split(/\s+/).filter(Boolean);
        text.text(''); // clear

        let line = [];
        let lineNumber = 0;
        const x = 0;
        const y = 0;
        const dy0 = 0; // we’ll re-center later
        let tspan = text.append('tspan').attr('x', x).attr('y', y).attr('dy', dy0 + 'em');

        for (let i = 0; i < words.length; i++) {
          line.push(words[i]);
          tspan.text(line.join(' '));
          const w = tspan.node().getComputedTextLength();
          if (w > maxWidth && line.length > 1) {
            line.pop();
            tspan.text(line.join(' '));
            line = [words[i]];
            lineNumber += 1;
            if (lineNumber >= maxLines) {
              // truncate last line
              const last = tspan.text();
              const ell = '…';
              let cut = last;
              while (tspan.node().getComputedTextLength() > maxWidth && cut.length) {
                cut = cut.slice(0, -1);
                tspan.text(cut + ell);
              }
              break;
            }
            tspan = text.append('tspan')
              .attr('x', x)
              .attr('y', y)
              .attr('dy', (lineNumber * lineHeightEm) + 'em')
              .text(words[i]);
          }
        }

        // vertically center the block of tspans
        const tspans = text.selectAll('tspan').nodes();
        const blockHeightEm = (tspans.length - 1) * lineHeightEm;
        tspans.forEach((node, idx) => {
          const dy = ((idx * lineHeightEm) - blockHeightEm / 2);
          d3.select(node).attr('dy', dy + 'em');
        });
      });
    }

    function wrapAllLabels() {
      // widths relative to node radii (a bit wider than the circle)
      catG.select('text.node-label').call(wrapText, P.catR * 2.2);
      subG.select('text.node-label').call(wrapText, P.subR * 2.6);
      skillG.select('text.node-label').call(wrapText, P.skillR * 3.0);
    }

    // =========================
    // RENDER
    // =========================
    function render() {
      core.x = cx; core.y = cy;

      coreG.attr('transform', `translate(${core.x},${core.y})`);
      gNodes.selectAll('g.category-node').attr('transform', d => `translate(${d.x},${d.y})`);
      gNodes.selectAll('g.subfocus-node').attr('transform', d => `translate(${d.x},${d.y})`);
      gNodes.selectAll('g.skill-node').attr('transform', d => `translate(${d.x},${d.y})`);

      linkSel
        .attr('x1', d => byId.get(d.source).x)
        .attr('y1', d => byId.get(d.source).y)
        .attr('x2', d => byId.get(d.target).x)
        .attr('y2', d => byId.get(d.target).y);

      // re-wrap labels (in case viewport/radii influence layout)
      wrapAllLabels();
      renderDebug();
    }

    // =========================
    // DRAG + CLICK (click only opens modal for skills)
    // =========================
    function showSkillModal(node) {
      const skill = node;
      const sub = byId.get(skill.parentId);
      const cat = byId.get(sub?.parentId || '');
      const title = skill.fullLabel || skill.label || 'Skill';
      const context = [cat?.fullLabel || cat?.label, sub?.fullLabel || sub?.label]
        .filter(Boolean).join(' • ');

      const relatedItems = Array.isArray(skill.related) && skill.related.length
        ? skill.related
        : (relatedIndex[skill.slug]?.items || []);

      const relatedList = relatedItems.map(item => {
        const href = item.url || '#';
        const safeTitle = escapeHtml(item.title || '');
        const kind = item.kind ? `<span class=\"text-muted small\">(${escapeHtml(item.kind)})</span>` : '';
        return `<li><a class=\"proj-link\" href=\"${href}\">${safeTitle}</a>${kind ? ` ${kind}` : ''}</li>`;
      }).join('');

      const contextHtml = context ? `<div class=\"modal-context\">${escapeHtml(context)}</div>` : '';
      const description = (skill.description || '').trim();
      const descriptionHtml = description
        ? `<p class=\"modal-description\">${escapeHtml(description)}</p>`
        : `<p class=\"modal-description modal-description--empty\">Add a brief description for this skill to highlight your experience.</p>`;
      const relatedHtml = relatedList
        ? `<h6 class=\"mt-3 mb-2\">Related work</h6><ul class=\"pl-3 proj-list\">${relatedList}</ul>`
        : '<p class=\"text-muted\">No linked projects yet.</p>';

      const modal = document.getElementById('skillModal');
      const accent = modal.querySelector('.modal-accent');
      if (accent) {
        if (skill.color) {
          accent.style.background = skill.color;
        } else {
          accent.style.background = 'linear-gradient(90deg, #f96332, #f6ad55)';
        }
      }
      document.getElementById('skillModalTitle').textContent = title;
      document.getElementById('skillModalBody').innerHTML = `
        ${contextHtml}
        ${descriptionHtml}
        ${relatedHtml}
      `;
      $('#skillModal').modal('show');
    }

    const dragNode = d3.drag()
      .on('start', (event, d) => { d.dragging = true; d._dragMoved = false; })
      .on('drag', (event, d) => {
        d._dragMoved = true;
        const nx = clamp(event.x, P.pad + d.r, width  - P.pad - d.r);
        const ny = clamp(event.y, P.pad + d.r, height - P.pad - d.r);
        d.vx = (nx - (d.x ?? nx)) / P.dt;
        d.vy = (ny - (d.y ?? ny)) / P.dt;
        d.x = nx; d.y = ny;
        render();
      })
      .on('end',  (event, d) => {
        const wasDrag = !!d._dragMoved;
        d.dragging = false;
        d._dragMoved = false;
        // treat as click if it was not dragged and it's a skill
        if (!wasDrag && d.type === 'skill') {
          showSkillModal(d);
        }
      });

    catG.call(dragNode); subG.call(dragNode); skillG.call(dragNode);

    // =========================
    // INIT / LOOP / UI
    // =========================
    function resize() {
      const b = container.getBoundingClientRect();
      width = Math.max(360, Math.floor(b.width));
      height = Math.max(420, Math.floor(b.height));
      d3.select(svgEl).attr('width', width).attr('height', height).attr('viewBox', `0 0 ${width} ${height}`);
      updateEllipseScales();
      cx = width / 2; cy = height / 2; core.x = cx; core.y = cy;
      seedSlices(); settle(); render();
    }
    function go() {
      const b = container.getBoundingClientRect();
      width = Math.max(360, Math.floor(b.width));
      height = Math.max(420, Math.floor(b.height));
      d3.select(svgEl).attr('width', width).attr('height', height).attr('viewBox', `0 0 ${width} ${height}`);
      updateEllipseScales();
      cx = width / 2; cy = height / 2; core.x = cx; core.y = cy;
      seedSlices(); settle(); render();
      d3.timer(() => { for (let i = 0; i < 2; i++) tick(); render(); });
    }

    // Panel wiring
    panelBtn.addEventListener('click', () => panel.classList.toggle('open'));
    toggleDebugInput.checked = showDebug;
    toggleDebugInput.addEventListener('change', (e) => { showDebug = !!e.target.checked; renderDebug(); });
    btnResetParams.addEventListener('click', () => {
      const restored = JSON.parse(JSON.stringify(P_DEFAULT));
      for (const k of Object.keys(P)) delete P[k];
      Object.assign(P, restored);
      syncSlidersFromParams();
      render();
    });

    const sliders = [
      { id: 'p-dt',          get: () => P.dt,                              set: v => P.dt = v, fmt: v => v.toFixed(3) },
      { id: 'p-damp',        get: () => P.damping,                         set: v => P.damping = v, fmt: v => v.toFixed(3) },
      { id: 'p-max',         get: () => P.maxSpeed,                        set: v => P.maxSpeed = v|0, fmt: v => (v|0) },
      { id: 'p-settle',      get: () => P.settleIters,                     set: v => P.settleIters = v|0, fmt: v => (v|0) },
      { id: 'ka-core-cat',   get: () => P.attraction.core__category.k,     set: v => P.attraction.core__category.k = v, fmt: v => v.toFixed(4) },
      { id: 'ka-cat-sub',    get: () => P.attraction.category__subfocus.k, set: v => P.attraction.category__subfocus.k = v, fmt: v => v.toFixed(3) },
      { id: 'ka-sub-skill',  get: () => P.attraction.subfocus__skill.k,    set: v => P.attraction.subfocus__skill.k = v, fmt: v => v.toFixed(3) },
      { id: 'rcore-cat',     get: () => P.repulsion.core__category.radius, set: v => P.repulsion.core__category.radius = v|0, fmt: v => (v|0) },
      { id: 'gap-cat-cat',   get: () => P.repulsion.category__category.gap,set: v => P.repulsion.category__category.gap = v|0, fmt: v => (v|0) },
      { id: 'gap-sub-sub',   get: () => P.repulsion.subfocus__subfocus.gap,set: v => P.repulsion.subfocus__subfocus.gap = v|0, fmt: v => (v|0) },
      { id: 'gap-skill-skill',get: () => P.repulsion.skill__skill.gap,     set: v => P.repulsion.skill__skill.gap = v|0, fmt: v => (v|0) },
    ];
    function syncSlidersFromParams() {
      sliders.forEach(s => {
        const el = document.getElementById(s.id); const val = s.get();
        el.value = val; const lab = document.getElementById(`${s.id}-val`);
        if (lab) lab.textContent = s.fmt(parseFloat(val));
      });
    }
    sliders.forEach(s => {
      const el = document.getElementById(s.id);
      const lab = document.getElementById(`${s.id}-val`);
      el.addEventListener('input', e => { const v = parseFloat(e.target.value); s.set(v); if (lab) lab.textContent = s.fmt(v); });
    });

    window.addEventListener('resize', resize);
    syncSlidersFromParams();
    go();

    const params = new URLSearchParams(window.location.search);
    const targetParam = params.get('skill');
    if (targetParam) {
      const decoded = decodeURIComponent(targetParam);
      const normalized = slugify(decoded);
      const node =
        skillBySlug.get(normalized) ||
        skills.find(k => slugify(k.label || '') === normalized || slugify(k.fullLabel || '') === normalized);
      if (node) {
        setTimeout(() => showSkillModal(node), 450);
      }
    }
  })();
  </script>
  <!-- Skill Details Modal -->
<!-- Skill details modal -->
  <div class="modal fade modal-skill" id="skillModal" tabindex="-1" role="dialog" aria-labelledby="skillModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-accent"></div>
        <div class="modal-header">
          <h5 class="modal-title" id="skillModalTitle">Skill</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" aria-label="Close modal">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="skillModalBody">
          <!-- JS fills this -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-round" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
